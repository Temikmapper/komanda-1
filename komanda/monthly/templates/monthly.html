{% extends 'yearly.html' %}
{% block settings %}
    <div class="block">
        <div class="columns">
            <div class="column">
                <h1 class="title">Per day: {{ daily_income }}</h1>
                <h2 class="subtitle">
                    <span>Free: {{ free_money }}</span>
                </h2>
            </div>
            <div class="column"></div>
            <div class="column" style="text-align:right;">
                <left>
                <form method="get" action={% url 'view_month_raw' year month %}>
                    <button class="button">
                        <span class="icon is-small"><i class="fa-regular fa-pen-to-square"></i></span><span>Edit expenses</span>
                    </button>
                </form>
                </left>
            </div>
        </div>
        <div class="tile is-vertical">
            <div class="tile is-child notification is-primary">
                <form method="get" action={% url 'view_monthly_incomes' year month %}>
                    <p class="title">
                        Incomes
                        <button class="button is-primary is-inverted">Edit</button>
                    </p>
                </form>
                <p class="subtitle">
                    {{ constant_incomes }}
                </p>
            </div>
            <div class="tile is-child notification is-warning">
                <form method="get" action={% url 'view_monthly_expenses' year month %}>
                    <p class="title">
                        Expenses
                        <button class="button is-warning is-inverted">Edit</button>
                    </p>
                </form>
                <p class="subtitle">
                    {{ constant_expenses }}
                </p>
            </div>
        </div>
    </div>
{% endblock %}
{% block spends_table %}
    <table class="table is-bordered is-striped is-narrow is-hoverable is-fullwidth">
        <thead>
            <tr>
                <th>
                    <abbr title="Position">Date</abbr>
                </th>
                <th>
                    <abbr title="Played">Trat</abbr>
                </th>
                <th>
                    <abbr title="Won">Kategr</abbr>
                </th>
                <th>
                    <abbr title="Won">Balance</abbr>
                </th>
            </tr>
        </thead>
        <tbody>
            {% for day in days %}
                <tr {% if day.date|date:"n" == date.month_ %} {% if day.date|date:"d" == date.day_ %} class="is-selected" {% endif %}
                    {% endif %}>
                    <th>{{ day.date|date:"d, D" }}</th>
                    <td>{{ day.amount }}</td>
                    <td>
                        {% for category in day.category %}
                            <span class="tag is-light {% if category == 'No spends' %} is-normal {% else %} is-warning {% endif %}"> {{ category }}</span>
                        {% endfor %}
                    </td>
                    <td>
                        {% if day.accumulated_balance < 0 %}
                            <span class="tag is-danger is-light is-medium">{{ day.accumulated_balance }}</span>
                        {% endif %}
                        {% if day.accumulated_balance > 0 %}
                            <span class="tag is-success is-light is-medium">{{ day.accumulated_balance }}</span>
                        {% endif %}
                    </td>
                </tr>
            {% endfor %}
        </tbody>
        <tfoot>
            <tr>
                <th>
                    <abbr title="Position">Total</abbr>
                </th>
                <th colspan="3">{{ total_expenses }}</th>
            </tr>
        </tfoot>
    </table>
{% endblock spends_table %}
{% block graphs %}
    {% load static %}
    <script src="{% static 'js/charts.min.js' %}"></script>
    <canvas id="expenses-chart" width="400" height="200"></canvas>
    <canvas id="bar-chart" width="800" height="450"></canvas>
    <script>
        $(document).ready(function () {
            var $expensesChart = $("#expenses-chart");
            $.ajax({
                data: $(this).serialize(),
                url: "{% url 'expenses_chart' year month %}",
                success: function (data) {
                    const skipped = (ctx, value) => ctx.p0.skip || ctx.p1.skip ? value : undefined;
                    ctx = $expensesChart[0].getContext('2d');
                    new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: data.labels,
                            datasets: [{
                                    label: 'Траты',
                                    data: data.data,
                                    borderColor: 'rgb(255, 99, 132)',
                                    cubicInterpolationMode: 'monotone',
                                    segment: {
                                        borderColor: ctx => skipped(ctx, 'rgb(0,0,0,0.2)'),
                                        borderDash: ctx => skipped(ctx, [6, 6]),
                                    },
                                    fill: false,
                                    spanGaps: true
                                    }]},
                        options: {
                            scales: { 
                                y: {
                                    min: 0,
                                    ticks: {
                                        // Include a dollar sign in the ticks
                                        callback: function(value, index, ticks) {
                                            return value + '₽';
                                        }
                                    }
                                }
                            },
                            legend: { display: false },
                            title: {
                                display: true,
                                text: 'Predicted world population (millions) in 2050'
                                }
                        }
                    });
                },
                error: function (data, jqXHR, textStatus, errorThrown) {
                    console.log(textStatus, errorThrown);
                }
            })
        })
        {% comment %} new Chart(document.getElementById("bar-chart"), {
            type: 'bar',
            data: {
              labels: ["Africa", "Asia", "Europe", "Latin America", "North America"],
              datasets: [
                {
                  label: "Population (millions)",
                  backgroundColor: ["#3e95cd", "#8e5ea2","#3cba9f","#e8c3b9","#c45850"],
                  data: [2478,5267,734,784,433]
                }
              ]
            }
        }); {% endcomment %}
    </script>
{% endblock graphs %}
